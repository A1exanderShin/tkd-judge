<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TKD Judge</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            padding: 20px;
        }
        .panel {
            background: #fff;
            padding: 14px;
            margin-bottom: 14px;
            border-radius: 6px;
        }
        button {
            padding: 8px 14px;
            margin: 4px;
            font-size: 14px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        td, th {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
        }
        .red { color: darkred; }
        .blue { color: darkblue; }
        .timer {
            font-size: 28px;
            font-weight: bold;
        }
        .hidden { display: none; }
        .center { text-align: center; }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .badge-round { background: #d4edda; }
        .badge-break { background: #fff3cd; }
    </style>
</head>

<body>

<h2>TKD Judge</h2>

<!-- ================= FIGHT MAIN JUDGE ================= -->
<div id="mainPanel" class="panel hidden">

    <div>
        <b>State:</b> <span id="state">‚Äî</span><br>
        <b>Phase:</b> <span id="phase">‚Äî</span><br>
        <b>Round:</b> <span id="round">‚Äî</span>
    </div>

    <div class="timer" id="timer">‚Äî</div>

    <hr>

    <h3>Score</h3>
    <h2>
        <span class="red" id="redScore">0</span>
        :
        <span class="blue" id="blueScore">0</span>
    </h2>

    <hr>

    <h3>Warnings</h3>
    <button onclick="warn('red')" class="red">‚ö† Red</button>
    <button onclick="warn('blue')" class="blue">‚ö† Blue</button><br><br>
    Red: <span id="warnRed">0</span>,
    Blue: <span id="warnBlue">0</span>

    <hr>

    <h3>Judges</h3>
    <table>
        <thead>
        <tr>
            <th>Judge</th>
            <th>Red</th>
            <th>Blue</th>
        </tr>
        </thead>
        <tbody id="judgesTable">
        <tr><td colspan="3">No data</td></tr>
        </tbody>
    </table>

    <hr>

    <button onclick="send('FIGHT_START')">Start</button>
    <button onclick="send('FIGHT_PAUSE')">Pause</button>
    <button onclick="send('FIGHT_STOP')">Stop</button>
    <button onclick="send('FIGHT_RESET')">Reset</button>
    <button onclick="send('SWITCH_DISCIPLINE')">Switch discipline</button>
</div>

<!-- ================= FIGHT SIDE JUDGE ================= -->
<div id="sidePanel" class="panel hidden center">

    <h3>Side judge</h3>
    <div><b>Judge ID:</b> <span id="judgeID">‚Äî</span></div>

    <h1>
        <span class="red" id="myRed">0</span>
        :
        <span class="blue" id="myBlue">0</span>
    </h1>

    <button onclick="score('red')" class="red">+1 Red</button>
    <button onclick="score('blue')" class="blue">+1 Blue</button>
</div>

<!-- ================= PATTERN MAIN JUDGE ================= -->
<div id="patternMainPanel" class="panel hidden">

    <h3>Pattern discipline</h3>

    <div>
        <b>State:</b> <span id="pState">‚Äî</span><br>
        <b>Stage:</b> <span id="pStage">‚Äî</span><br>
        <b>Exercise:</b> <span id="pExercise">‚Äî</span>
    </div>

    <hr>

    <input id="exerciseInput" placeholder="Exercise name">
    <button onclick="selectExercise()">Select exercise</button>

    <hr>

    <h3>Total score: <span id="pTotal">0</span></h3>

    <button onclick="nextStage()">Next stage</button>
    <button onclick="finishPattern()">Finish</button>
    <button onclick="send('SWITCH_DISCIPLINE')">Switch discipline</button>
</div>

<!-- ================= PATTERN SIDE JUDGE ================= -->
<div id="patternSidePanel" class="panel hidden center">

    <h3>Pattern ‚Äì Side judge</h3>
    <div>Judge: <b id="pJudgeID">‚Äî</b></div>

    <hr>

    <div id="criteriaPanel"></div>
</div>

<script>
    const qs = new URLSearchParams(location.search);
    const role = qs.get("role") || "side";
    const judge = qs.get("judge");

    let ws;
    let myJudgeID = judge ? Number(judge) : null;

    const criteria = ["technique","balance","power","rhythm","expression"];

    function connect() {
        let url = "ws://" + location.host + "/ws?role=" + role;
        if (judge) url += "&judge=" + judge;

        ws = new WebSocket(url);
        ws.onmessage = e => handle(JSON.parse(e.data));
    }

    function handle(msg) {
        if (msg.type === "snapshot") {
            renderSnapshot(msg.data);
        }
        if (msg.type === "timer") {
            renderTimer(msg.data);
        }
    }

    function renderSnapshot(d) {
        if (d.type === "fight") {
            mainPanel.classList.toggle("hidden", role !== "main");
            sidePanel.classList.toggle("hidden", role === "main");
            patternMainPanel.classList.add("hidden");
            patternSidePanel.classList.add("hidden");

            renderFight(d);
            return;
        }

        if (d.type === "pattern") {
            mainPanel.classList.add("hidden");
            sidePanel.classList.add("hidden");

            if (role === "main") {
                patternMainPanel.classList.remove("hidden");
            } else {
                patternSidePanel.classList.remove("hidden");
                renderCriteria();
                pJudgeID.textContent = myJudgeID;
            }
            renderPattern(d);
        }
    }

    /* ================= FIGHT ================= */

    function renderFight(d) {
        state.textContent = d.state;
        round.textContent = d.round + " / " + d.rounds;
        redScore.textContent = d.red;
        blueScore.textContent = d.blue;
        warnRed.textContent = d.warnings.red;
        warnBlue.textContent = d.warnings.blue;
    }

    function renderTimer(t) {
        timer.textContent = t.seconds + " s";
        phase.innerHTML = t.mode === "round"
            ? '<span class="badge badge-round">ROUND</span>'
            : t.mode === "break"
                ? '<span class="badge badge-break">BREAK</span>'
                : "‚Äî";
    }

    /* ================= PATTERN ================= */

    function renderPattern(d) {
        pState.textContent = d.state;
        pStage.textContent = d.stage;
        pExercise.textContent = d.exercise || "‚Äî";
        pTotal.textContent = d.total || 0;
    }

    function renderCriteria() {
        criteriaPanel.innerHTML = "";
        criteria.forEach(c => {
            const div = document.createElement("div");
            div.innerHTML = `<b>${c}</b><br>` +
                [0,2,4,6,8,10].map(v =>
                    `<button onclick="judgeScore('${c}',${v})">${v}</button>`
                ).join("") +
                "<hr>";
            criteriaPanel.appendChild(div);
        });
    }

    /* ================= ACTIONS ================= */

    function send(type) {
        ws.send(JSON.stringify({ type }));
    }

    function score(fighter) {
        ws.send(JSON.stringify({ type:"FIGHT_SCORE", fighter, points:1 }));
    }

    function warn(fighter) {
        ws.send(JSON.stringify({ type:"FIGHT_WARNING", fighter }));
    }

    function selectExercise() {
        ws.send(JSON.stringify({
            type: "PATTERN_SELECT_EXERCISE",
            exercise: exerciseInput.value
        }));
    }

    function judgeScore(criterion, score) {
        ws.send(JSON.stringify({
            type: "PATTERN_JUDGE_SCORE",
            judgeID: myJudgeID,   // üî• –í–ê–ñ–ù–û
            criterion,
            score
        }));
    }

    function nextStage() {
        ws.send(JSON.stringify({ type: "PATTERN_NEXT_STAGE" }));
    }

    function finishPattern() {
        ws.send(JSON.stringify({ type: "PATTERN_FINISH" }));
    }

    if (role === "main") {
        mainPanel.classList.remove("hidden");
    } else {
        sidePanel.classList.remove("hidden");
        judgeID.textContent = myJudgeID;
    }

    connect();
</script>

</body>
</html>
