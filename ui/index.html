<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TKD Judge</title>

    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            padding: 20px;
        }
        .panel {
            background: #fff;
            padding: 14px;
            margin-bottom: 14px;
            border-radius: 6px;
        }
        button {
            padding: 8px 14px;
            margin: 4px;
            font-size: 14px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        td, th {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
        }
        .red { color: darkred; }
        .blue { color: darkblue; }
        .timer {
            font-size: 28px;
            font-weight: bold;
        }
        .hidden { display: none; }
        .center { text-align: center; }
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
        }
        .badge-round { background: #d4edda; }
        .badge-break { background: #fff3cd; }
    </style>
</head>

<body>

<h2>TKD Judge</h2>

<!-- ================= MAIN JUDGE ================= -->
<div id="mainPanel" class="panel hidden">

    <div>
        <b>State:</b> <span id="state">—</span><br>
        <b>Phase:</b> <span id="phase">—</span><br>
        <b>Round:</b> <span id="round">—</span>
    </div>

    <div class="timer" id="timer">—</div>

    <hr>

    <h3>Score</h3>
    <h2>
        <span class="red" id="redScore">0</span>
        :
        <span class="blue" id="blueScore">0</span>
    </h2>

    <hr>

    <h3>Warnings</h3>
    <button onclick="warn('red')" class="red">⚠ Red</button>
    <button onclick="warn('blue')" class="blue">⚠ Blue</button><br><br>
    Red: <span id="warnRed">0</span>,
    Blue: <span id="warnBlue">0</span>

    <hr>

    <h3>Judges</h3>
    <table>
        <thead>
        <tr>
            <th>Judge</th>
            <th>Red</th>
            <th>Blue</th>
        </tr>
        </thead>
        <tbody id="judgesTable">
        <tr><td colspan="3">No data</td></tr>
        </tbody>
    </table>

    <hr>

    <button onclick="send('FIGHT_START')">Start</button>
    <button onclick="send('FIGHT_PAUSE')">Pause</button>
    <button onclick="send('FIGHT_STOP')">Stop</button>
    <button onclick="send('FIGHT_RESET')">Reset</button>

    <hr>

    <h3>Settings</h3>

    <label>Rounds:
        <input type="number" id="setRounds" min="1" value="1">
    </label><br><br>

    <label>Round duration (sec):
        <input type="number" id="setRoundTime" min="10" value="120">
    </label><br><br>

    <label>Break duration (sec):
        <input type="number" id="setBreakTime" min="5" value="30">
    </label><br><br>

    <button onclick="applySettings()">Apply settings</button>
</div>

<!-- ================= SIDE JUDGE ================= -->
<div id="sidePanel" class="panel hidden center">

    <h3>Side judge</h3>
    <div><b>Judge ID:</b> <span id="judgeID">—</span></div>

    <h1>
        <span class="red" id="myRed">0</span>
        :
        <span class="blue" id="myBlue">0</span>
    </h1>

    <button onclick="score('red')" class="red">+1 Red</button>
    <button onclick="score('blue')" class="blue">+1 Blue</button>
</div>

<script>
    const qs = new URLSearchParams(location.search);
    const role = qs.get("role") || "side";
    const judge = qs.get("judge");

    let ws;
    let myJudgeID = judge ? Number(judge) : null;

    function connect() {
        let url = "ws://" + location.host + "/ws?role=" + role;
        if (judge) url += "&judge=" + judge;

        ws = new WebSocket(url);
        ws.onmessage = e => handle(JSON.parse(e.data));
    }

    function handle(msg) {
        if (msg.type === "snapshot") {
            renderSnapshot(msg.data);
        }

        if (msg.type === "timer") {
            renderTimer(msg.data);
        }
    }

    function renderSnapshot(d) {
        document.getElementById("state").textContent = d.state;
        document.getElementById("round").textContent = d.round + " / " + d.rounds;

        document.getElementById("redScore").textContent = d.red;
        document.getElementById("blueScore").textContent = d.blue;

        document.getElementById("warnRed").textContent = d.warnings.red;
        document.getElementById("warnBlue").textContent = d.warnings.blue;

        renderJudges(d.judges);
    }

    function renderTimer(t) {
        const timer = document.getElementById("timer");
        const phase = document.getElementById("phase");

        timer.textContent = t.seconds + " s";

        if (t.mode === "round") {
            phase.innerHTML = '<span class="badge badge-round">ROUND</span>';
        } else if (t.mode === "break") {
            phase.innerHTML = '<span class="badge badge-break">BREAK</span>';
        } else {
            phase.textContent = "—";
        }
    }

    function renderJudges(judges) {
        const body = document.getElementById("judgesTable");
        body.innerHTML = "";

        if (!judges || judges.length === 0) {
            body.innerHTML = "<tr><td colspan='3'>No judges</td></tr>";
            return;
        }

        judges.forEach(j => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${j.id}</td><td>${j.red}</td><td>${j.blue}</td>`;
            body.appendChild(tr);

            if (j.id === myJudgeID) {
                document.getElementById("myRed").textContent = j.red;
                document.getElementById("myBlue").textContent = j.blue;
            }
        });
    }

    function send(type) {
        ws.send(JSON.stringify({ type }));
    }

    function score(fighter) {
        ws.send(JSON.stringify({
            type: "FIGHT_SCORE",
            fighter,
            points: 1
        }));
    }

    function warn(fighter) {
        ws.send(JSON.stringify({
            type: "FIGHT_WARNING",
            fighter
        }));
    }

    function applySettings() {
        ws.send(JSON.stringify({
            type: "FIGHT_SETTINGS",
            rounds: Number(setRounds.value),
            round_duration: Number(setRoundTime.value),
            break_duration: Number(setBreakTime.value)
        }));
    }

    if (role === "main") {
        document.getElementById("mainPanel").classList.remove("hidden");
    } else {
        document.getElementById("sidePanel").classList.remove("hidden");
        document.getElementById("judgeID").textContent = myJudgeID;
    }

    connect();
</script>

</body>
</html>
